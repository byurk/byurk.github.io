<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>R on HPC</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="055_RonHPC_files/libs/clipboard/clipboard.min.js"></script>
<script src="055_RonHPC_files/libs/quarto-html/quarto.js"></script>
<script src="055_RonHPC_files/libs/quarto-html/popper.min.js"></script>
<script src="055_RonHPC_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="055_RonHPC_files/libs/quarto-html/anchor.min.js"></script>
<link href="055_RonHPC_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="055_RonHPC_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="055_RonHPC_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="055_RonHPC_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="055_RonHPC_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">R on HPC</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>When working with large data sets computations can take a long time and can often require more resources than are available on a personal computer. In this case it is useful (sometimes essential) to run some of your computations on a shared computer with more resources. In this tutorial you will learn how to run your R code on a high performance computing cluster (HPC) that is located on Hope’s campus.</p>
<p>We will take a hybrid approach that takes advantage of the different strengths of the HPC and your local computer (e.g., your laptop or desktop computer). It is usually more efficient to write code, generate plots, and view numerical and graphical summaries of data on your local computer. However, sometimes we will need to offload heavier computations to the HPC. Our workflow will require us to move data and code back and forth between your local computer and the cluster to take advantage of both resources.</p>
</section>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>In this tutorial we will assume that you have <a href="https://faculty.hope.edu/yurk/watershed_tutorials/000_Install_R_RStudio.html">R and RStudio installed on your local computer</a>, and that you are familiar with the <a href="https://faculty.hope.edu/yurk/watershed_tutorials/010_Introduction_R_RStudio.html">RStudio interface</a>. We also assume that you are familiar with RStudio projects, the standard directory structure we use for projects in the Watershed course, and Quarto documents. These are all introduced in <a href="https://faculty.hope.edu/yurk/watershed_tutorials/020_Introduction_Quarto.html">this tutorial</a>. Throughout this tutorial we will work with a project called <em>watershedMacatawa</em>. If you are working on a different project, you will simply need to replace <em>watershedMacatawa</em> with the name of your project.</p>
<p>There are various ways to interact with HPC from your local computer and to move files back and forth between your local computer and HPC. We will assume that you are using ssh to log in to HPC using your terminal application (Mac) or MobaXterm (Windows). If you are using Windows you can access the HPC filesystem within MobaXterm. If you are using a Mac you can mount your HPC filesystem using MacFuse and SSHFS. Instructions for doing these things from either on or off campus are in the documents for <a href="https://docs.google.com/document/d/18XEnM5Y8a6OHnn7rBDOf_hZableK_OHSmWKCckA9ldI/edit#heading=h.s2dqi4yf9hau">Mac users</a> and <a href="https://docs.google.com/document/d/1ec8TgRhP9hbV_W9m_0vvVfYOjmfYyhLBsnAfXa7X6DM/edit#heading=h.cw5akhykb15f">Windows users</a>. These approaches make it easy to upload files to HPC from your local computer, download files from HPC to your local computer, and edit files that are on HPC using your local computer. In particular, we will be able to use RStudio on your local computer to edit Quarto files located on HPC. We will upload Quarto files that you have created on your local computer to HPC.</p>
<p>Finally, we will assume that you are familiar with basic Unix commands as described in this <a href="https://swcarpentry.github.io/shell-novice/">Software Carpentry Unix shell introduction</a>. (You may also want to keep this <a href="https://swcarpentry.github.io/shell-novice/reference.html">Software Carpentry Unix shell cheatsheet</a> handy).</p>
</section>
<section id="setting-up-your-watershedmacatawa-project-on-hpc-do-this-the-first-time-you-set-up-each-project-on-hpc" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-your-watershedmacatawa-project-on-hpc-do-this-the-first-time-you-set-up-each-project-on-hpc">Setting up your <em>watershedMacatawa</em> project on HPC (do this the first time you set up each project on HPC)</h2>
<p>We will walk through the process of creating the directory structure for an R project on HPC. You will need to do something similar every time you want to work on a new project.</p>
<p>We will also copy some code and data from an existing folder on HPC into your project so that you can run your first job on HPC. <em>Some of this is specifically for your first time using running R code on HPC in the watershed course.</em> If you are working on a different project in the future you will need to copy the code and data you need into the corresponding directories in your project before you run your code. You may be copying these (or linking them) from another directory on HPC or you may be uploading them from your local machine.</p>
<section id="project-directory-structure-on-hpc" class="level3">
<h3 class="anchored" data-anchor-id="project-directory-structure-on-hpc">Project directory structure on HPC</h3>
<p>Log into HPC. We will create the <em>watershedMacatawa</em> project directory structure on HPC. (You should already have a <em>watershedMacatawa</em> project with this directory structure on your local computer).</p>
<p>We will assume that this is the first R project you have created on HPC. We will start by creating a <em>Projects</em> directory in your home directory. This will host all of your R projects. Start be making sure you are in your home directory by entering the following command:</p>
<pre><code>cd</code></pre>
<p>Create the <em>Projects</em> directory and enter it. (If you already have a <em>Projects</em> directory in your home directory do not include the <code>mkdir Projects</code> command).</p>
<pre><code>mkdir Projects
cd Projects</code></pre>
<p>Create your <em>watershedMacatawa</em> directory and enter it</p>
<pre><code>mkdir watershedMacatawa
cd watershedMacatawa</code></pre>
<p>Create your <em>code</em>, <em>raw_data</em>, <em>clean_data</em>, and <em>outputs</em> and check your work.</p>
<pre><code>mkdir code raw_data clean_data outputs
ls -F</code></pre>
<p>If you misspelled something, remove it (e.g., <code>rm -r ootputs</code>) and create it again. We will also create a <em>slurm</em> subdirectory within the <em>code</em> directory that will host slurm scipts that we will use to submit jobs to HPC. Move into the code directory and create the <em>slurm</em> directory.</p>
<pre><code>cd code
mkdir slurm</code></pre>
<p>Let’s view the entire directory structure that we have created so far. Is everything where it is supposed to be?</p>
<pre><code>ls -RF ~/Projects</code></pre>
<p>Now move back into the <em>watershedMacatawa</em> directory.</p>
<pre><code>cd ~/Projects/watershedMacatawa</code></pre>
<p>Finally, check the directory structure in the left pane of the MobaXterm window (Windows) or in your mounted HPC home directory using Finder (Mac).</p>
</section>
<section id="copying-code-and-linking-data-into-your-hpc-project-for-your-first-time-setting-up-your-watershedmacatawa-project-on-hpc" class="level3">
<h3 class="anchored" data-anchor-id="copying-code-and-linking-data-into-your-hpc-project-for-your-first-time-setting-up-your-watershedmacatawa-project-on-hpc">Copying code and linking data into your HPC project (for your first time setting up your <em>watershedMacatawa</em> project on HPC)</h3>
<p>The first time we submit a job on HPC in the watershed class, we want everyone to have the same code and to be working with the same data files. Rather than uploading the code and data to HPC from your local computer, you will copy existing code from a directory that is already on HPC. You will also create a link to the raw data files, which are already stored in another directory on HPC. This will reduce the amount of storage space we are using on the cluster, since we will all be using the same copy of the data instead of each of us making our own copy. However, by linking to the data it will appear to R as if the files are actually in your <em>raw_data</em> directory instead of in some other directory on the cluster.</p>
<p>First you will copy a project file and yaml file into your <em>watershedMacatawa</em> directory.</p>
<pre><code>cd ~/Projects/watershedMacatawa
cp /home/byurk/water_share/_quarto.yml .
cp /home/byurk/water_share/watershedMacatawa.Rproj .</code></pre>
<p>Next you will copy a Quarto file into your <em>code</em> directory. Start by moving into your directory, then copy the file.</p>
<pre><code>cd ~/Projects/watershedMacatawa/code
cp /home/byurk/water_share/code/Mac_Data_Explore_Read_Histo.qmd .</code></pre>
<p>Next, move into your <em>slurm</em> directory and copy the slurm script you will need to run your code on HPC.</p>
<pre><code>cd slurm
cp /home/byurk/water_share/code/slurm/mac_explore_read_histo_qmd.slurm .</code></pre>
<p>Check to make sure you can open these files from your mounted home directory (Mac) or from MobaXterm (Windows) on your local computer using RStudio. Note that if you edit the files and save the changes in RStudio using your local computer, the changes will be saved on HPC! Make a small change to the Quarto file (not to the R code, though) and save the file to make sure it works. If you do the following on HPC, the output should reflect the changes you made using your local computer. Check to make sure this is the case.</p>
<pre><code>cd ~/Projects/watershedMacatawa/code
cat Mac_Data_Explore_Read_Histo.qmd</code></pre>
<p>Next we will create links to the raw data files we will need for this project. The links we are using are referred to as <em>symbolic links</em>. Instead of copying the data we are just creating a file that tells the computer where to look for it. Start by moving into your <em>raw_data</em> directory then creating a link to the .shared file.</p>
<pre><code>cd ~/Projects/watershedMacatawa/raw_data
ln -s /home/byurk/water_share/raw_data/mac2024_RUNS1-2-3-5-6-7-8b-9-10-11-12-14-15_2024-01-18.shared .</code></pre>
<p>Next we create a link to the .taxonomy file</p>
<pre><code>ln -s /home/byurk/water_share/raw_data/mac2024_RUNS1-2-3-5-6-7-8b-9-10-11-12-14-15_2024-01-18.taxonomy .</code></pre>
<p>and finally the metadata file</p>
<pre><code>ln -s /home/byurk/water_share/raw_data/watershedMetadataCourseSpring2024.csv .</code></pre>
<p>Let’s check our work. Links should be indicated by an @ symbol.</p>
<pre><code>ls -F</code></pre>
<p>We can also see the files that are links are pointing to.</p>
<pre><code>ls -l</code></pre>
</section>
<section id="copying-code-and-data-from-your-local-computer" class="level3">
<h3 class="anchored" data-anchor-id="copying-code-and-data-from-your-local-computer">Copying code and data from your local computer</h3>
<p>In many cases you will have code and data on your local computer that you want to use for computions on HPC. In this case, instead of copying (or linking) data and code from another directory on the cluster you will simply need to copy the files you need from your local project directories to the corresponding directories on HPC. You can use MobaXterm (Windows) or Finder (Mac) to do this.</p>
</section>
</section>
<section id="running-your-code-on-hpc-do-this-every-time" class="level2">
<h2 class="anchored" data-anchor-id="running-your-code-on-hpc-do-this-every-time">Running your code on HPC (do this every time)</h2>
<p>Once you have the Quarto file that you want to run in your <em>code</em> directory on HPC and your raw data in the <em>raw_data</em> directory you are ready to run your code. (In some cases your code may use data in the <em>clean_data</em> directory, which includes results from previous computations. Of course if this is the case you will need to make sure these files are in the <em>clean_data</em> directory on HPC.)</p>
<p>HPC uses work load management software called <em>Slurm</em> to determine how jobs that are submitted by users will be run on the cluster. In particular, <em>Slurm</em> determines when a job will be run and which resources will be available for the job.</p>
<p>HPC also uses a container system called <em>Singularity</em> for computations. Singularity containers contain programs that can be used to perform certain tasks. R is <em>not</em> installed on HPC. Instead, there are several containers on HPC that include R. Running a container is like running a separate computer that has its own software installed but that shares some of the resources of the computer system that is running the container. In particular, your home directory is available when working in a container. One advantage of using containers is that your project becomes more portable. If you share both the code <em>and the container</em> that you used, then someone can run your code using exactly the same software versions as you did. This also allows you to run code for your new projects using new versions of R while running the code for your old projects using the versions of R that you originally used.</p>
<p>To run a job on HPC we need to submit it to Slurm. We do this using a script that has a <em>.slurm</em> extension. The following is a simple example of a slurm script. If you followed the instructions in the section <strong>Copying code and linking data into your HPC project (for your first time setting up your <em>watershedMacatawa</em> project on HPC)</strong> then this is the slurm script that you copied into your <em>slurm</em> directory. At the top of the script is some information telling Slurm how we would like to set up the job (commands starting with #SBATCH). Other lines starting with # are comments that will not be run.</p>
<p>We will go through the details of the Slurm script in class, but at this point we will point out that the line <code>QMDfile=Mac_Data_Explore_Read_Histo.qmd</code> is really the only thing you need to change to execute a different Quarto file in your code directory. It is also a good idea to change the <em>job-name</em> to something that better describes your job.</p>
<p>If we run this Slurm file, Slurm will open a container called <em>r.sif</em> that includes R, and it will run a command that will render the <em>Mac_Data_Explore_Read_Histo.qmd</em> file into .html output (similar to rendering a document in RStudio). This is all done in a single line in the Slurm script (the line starting with the command <em>singularity</em>).</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>#!/bin/bash
#SBATCH --job-name=mac_explore_read_histo
#SBATCH --partition=curie-best
#SBATCH --exclude=curie201,curie209
#SBATCH --ntasks=5
#SBATCH --mem=32G


# This script renders a Quarto file to obtain html output
# Assumes that user has the directory structure we have adopted for the watershed course
# The directory for the project should include a code subdirectory where the qmd file is located
# project path should be path the the project directory
# Output file will have the same name but different exension (.html instead of .qmd)
# I have been running this from within .../code/slurm in the project directory

umask 000

sif_file_for_R=${SIF_FILES}/r.sif
projectpath=~/Projects/watershedMacatawa
QMDfile=Mac_Data_Explore_Read_Histo.qmd

startsec=`date +%s`  #%s gives 'epoch time' which is num secs since 1970-01-01
echo Starting job at `date`

echo Running on host `hostname`
echo Shell is $SHELL
echo Group is `id -gn`

# Execute R script
echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
echo "Running script"
cd $projectpath
echo The working directory is `pwd`
inQMD=$projectpath/code/$QMDfile
singularity run --bind /home/byurk/water_share/raw_data $sif_file_for_R quarto render $inQMD --to html
echo Done

echo ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
endsec=`date +%s`
echo Ending job at `date`

let "wallsec = $endsec - $startsec "
wallhrs=`echo "scale=2; $wallsec / 60 / 60 " | bc -l `
echo Total wallclock time was $wallhrs hours.</code></pre>
</div>
</div>
<p>To run the Slurm job we first move into the slurm directory, then we use the sbatch command.</p>
<pre><code>cd ~/Projects/watershedMacatawa/code/slurm
sbatch mac_explore_read_histo_qmd.slurm</code></pre>
<p>After you submit the job to Slurm it will print out a message like <em>Submitted batch job 17101</em> (the number for your job will be different).</p>
<p>You can check on the status of your Slurm jobs by entering</p>
<pre><code>squeue</code></pre>
<p>If your job is still running you should see it listed in the resulting table. You can identify your job using the <em>JOBID</em> or the <em>NAME</em> (if you gave it a unique name in the Slurm script). If your job is done running already it will not show up in the table.</p>
<p>Any output from your code along with output from your slurm script will be written to a file called <em>slurm-17101.out</em> (with your job ID instead of 17101). This file will be updated whenever there is new output, so you can view it’s content to check on the status of your job. For job 17101 this can be achieved by entering the following command while you are in the <em>slurm</em> directory:</p>
<pre><code>cat slurm-17101.out</code></pre>
<p>When your code has finished running, the rendered .html file should appear in your <em>code</em> directory. To check this we can list the files in the directory and look for the .html file. To do this from within the <em>slurm</em> directory we can use the following commands:</p>
<pre><code>cd ..
ls -F</code></pre>
</section>
<section id="dowloading-output-to-your-local-computer" class="level2">
<h2 class="anchored" data-anchor-id="dowloading-output-to-your-local-computer">Dowloading output to your local computer</h2>
<p>Once the computation is done you can download the resulting output to your local computer. For example, running the <em>Mac_Data_Explore_Read_Histo.qmd</em> file will produce a rendered .html file called <em>Mac_Data_Explore_Read_Histo.html</em>, three clean data files: <em>macatawa.rds</em>, <em>macatawa_tax.rds</em>, and <em>macatawa_meta.rds</em>, and a plot file <em>mac2024_seq_depth-fwdb.pdf</em>. You should download these files to <em>watershedMacatawa</em> project directory on your local computer, placing the .html file in your local <em>code</em> directory, the clean data files in your <em>clean_data</em> directory, and the plot file in your <em>outputs</em> directory. You should also leave copies of the files on the cluster. This way you can do further computations using either your local computer or the cluster while using the same clean date files for the computation. View the .html file using a web browser (like Chrome) on your local computer.</p>
<p>You should also download the Quarto file and save it in your local <em>code</em> directory so that you can have a local copy of it.</p>
</section>
<section id="troubleshooting" class="level2">
<h2 class="anchored" data-anchor-id="troubleshooting">Troubleshooting</h2>
<p>If your code fails to run or if it does not produce the expected output (e.g., there is an error message or missing output in your rendered report), you may need to edit the Quarto file and before submitting another Slurm job. You should do this by opening the file in RStudio on your local computer (as you did earlier), editing it, and saving it so that the changes are reflected on the cluster. Then just use the same approach you used earlier to submit a new Slurm job and monitor it.</p>
</section>
<section id="variations-in-workflow" class="level2">
<h2 class="anchored" data-anchor-id="variations-in-workflow">Variations in workflow</h2>
<p>We have already discussed the fact that in some cases you will be uploading data to the cluster instead of copying it from other locations on the cluster.</p>
<p>In some cases you will write code (a Quarto) on your local computer while you are not connected to HPC, then you will copy that code to HPC so that you can run it.</p>
<p>Since you may have different versions of the same file in two different places with this approach is very important to keep track of which version you have locally and which version you have on the cluster. It is also important to know which version you are editing on your local machine (is it a version that is on HPC or on your local file system?). In particular, you should keep track of your most recent version and make an effort to have a copy of that version in both places.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>